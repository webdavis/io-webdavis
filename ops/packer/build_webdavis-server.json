{
    "variables": {
        "file_url" : "https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2021-01-12/2021-01-11-raspios-buster-armhf-lite.zip",
        "isotime": "{{isotime \"20060102030405\"}}",
        "ansible_vault_password": "{{env `ANSIBLE_VAULT_PASSWORD`}}"
    },
    "min_packer_version": "1.6.6",
    "builders": [{
        "name": "webdavis-server",
        "type": "arm",
        "image_mount_path": "/mnt/packer-raspberry-chroot",
        "file_urls" : ["{{user `file_url`}}"],
        "file_checksum_url": "{{user `file_url`}}.sha256",
        "file_checksum_type": "sha256",
        "file_target_extension": "zip",
        "image_build_method": "resize",
        "image_path": "webdavis-server-{{user `isotime`}}.img",
        "image_size": "8G",
        "image_type": "dos",
        "image_partitions": [{
            "name": "boot",
            "type": "c",
            "start_sector": "8192",
            "filesystem": "vfat",
            "size": "256M",
            "mountpoint": "/boot"
        },
        {
            "name": "root",
            "type": "83",
            "start_sector": "532480",
            "filesystem": "ext4",
            "size": "0",
            "mountpoint": "/"
        }
        ],
        "image_chroot_env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.local/bin"],
        "qemu_binary_source_path": "/usr/bin/qemu-arm-static",
        "qemu_binary_destination_path": "/usr/bin/qemu-arm-static"
    }],
    "provisioners": [{
        "type": "shell",
        "script": "./scripts/install-ansible"
    },
    {
        "type": "ansible-local",
        "command": "PYTHONUNBUFFERED=1 ANSIBLE_VAULT_PASSWORD='{{user `ansible_vault_password`}}' ansible-playbook",
        "playbook_file": "./build_webdavis-server.yml",
        "playbook_dir": "./",
        "extra_arguments": [
            "-e ansible_python-interpreter=/usr/bin/python3",
            "--limit=localhost",
            "--vault-password-file vault.password.py"
	]

    },
    {
        "type": "shell",
        "script": "./scripts/remove-ansible"
    }],
    "post-processors": [{
        "only": ["webdavis-server"],
        "type": "manifest",
        "output": "manifest_webdavis-server.json",
        "strip_path": true
    }]
}
